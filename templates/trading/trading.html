{% extends "base.html" %}
{% load static %}

{% block content %}
    <head>
        <link rel="stylesheet" href="{% static 'css/style.css' %}">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>

    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
        }

        .bg-light {
            background-color: #333 !important;
        }

        .text-dark {
            color: #e0e0e0 !important;
        }

        #tradingview-widget {
            width: 100%;
            height: 500px;
            margin-top: 20px;
        }

        .trade-buttons {
            margin-top: 20px;
            display: flex;
            align-items: center;
        }

        .trade-quantity {
            display: flex;
            align-items: center;
            margin-right: 10px;
        }

        .trade-buttons button {
            margin-right: 10px;
            align-items: center;
        }

        .trade-quantity {
            display: flex;
            align-items: center;
            margin-right: 10px; /* 버튼과의 간격 조정 */
        }

        .trade-quantity input {
            width: 60px; /* 수량 입력 칸 너비 조정 */
            text-align: center; /* 가운데 정렬 */
            margin: 0 5px; /* 버튼과의 간격 조정 */
            border-radius: 5px; /* 모서리 둥글게 */
            border: 1px solid #1e1e1e; /* 테두리 색상 */
            background-color: #1e1e1e; /* 배경색 */
            color: black; /* 텍스트 색상 */
            height: 40px;
        }

        .trade-buttons .btn-success {
            background-color: darkolivegreen;
            border-color: darkolivegreen;
        }

        .trade-buttons .btn-danger {
            background-color: maroon;
            border-color: maroon;
        }

        .trade-quantity button {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            color: #1e1e1e;
            background-color: gray;
        }

        .trade-buttons button {
            padding: 10px 20px;
            border-radius: 5px;
            height: 40px;
            align-self: stretch;
        }

        .toast {
            background-color: #ffffff;
            color: black;
            border: none;
            box-shadow: none;
            border-radius: 0.5rem;
        }

        .toast-header {
            background-color: #2c2c2c;
            color: #ffffff;
        }

        /* 로딩창 */
        #loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            color: #fff;
            text-align: center;
            padding-top: 20%;
        }

        .progress-bar {
            position: relative;
            width: 50%;
            height: 30px;
            background-color: #333;
            margin: 20px auto;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            width: 0;
            background-color: #007bff;
            transition: width 0.4s ease;
        }

        #progress-percent {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            z-index: 1;
        }

    </style>

    <!-- 로딩창 -->
    <div id="loading">
        <div class="progress-bar">
            <div class="progress"></div>
            <span id="progress-percent">0%</span>
        </div>
        <p>Loading...</p>
    </div>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar">
                <div class="position-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'dashboard' %}">
                                <i class="bi bi-house-door"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-light" href="{% url 'trading' %}">
                                <i class="bi bi-currency-exchange"></i> Trading
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-graph-up"></i> Analytics
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-wallet2"></i> Portfolio
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="{% url 'articles' %}" id="crawl-articles-btn">
                                <i class="bi bi-newspaper"></i> Articles
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Trading</h1>
                </div>

                <!-- TradingView 차트 -->
                <div id="tradingview-widget"></div>

                <!-- 매수/매도 -->
                <div class="trade-buttons">
                    <div class="trade-quantity">
                        <button id="decrease-btn" class="btn btn-secondary">-</button>
                        <input type="number" id="quantity" value="1" class="form-control mb-2" min="1" readonly>
                        <button id="increase-btn" class="btn btn-secondary">+</button>
                    </div>
                    <button id="buy-btn" class="btn btn-success">Buy</button>
                    <button id="sell-btn" class="btn btn-danger">Sell</button>
                </div>

                <!-- 토스트 -->
                <div class="toast-container position-fixed bottom-0 end-0 p-3">
                    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header">
                            <strong class="me-auto">Alert</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body" id="toast-message">
                            The buy order was not executed.
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- TradingView Widget Script -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // TradingView 차트 로드
            new TradingView.widget({
                "container_id": "tradingview-widget",
                "autosize": true,
                "symbol": "AAPL",
                "interval": "D",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "allow_symbol_change": true,
                "hide_side_toolbar": false,
            });

            // 수량 증가 및 감소 기능
            document.getElementById('increase-btn').addEventListener('click', function () {
                const quantityInput = document.getElementById('quantity');
                quantityInput.value = parseInt(quantityInput.value) + 1;
            });

            document.getElementById('decrease-btn').addEventListener('click', function () {
                const quantityInput = document.getElementById('quantity');
                if (quantityInput.value > 1) {
                    quantityInput.value = parseInt(quantityInput.value) - 1;
                }
            });

            // 매수/매도 요청 처리
            document.getElementById('buy-btn').addEventListener('click', function () {
                tradeStock('buy');
            });

            document.getElementById('sell-btn').addEventListener('click', function () {
                tradeStock('sell');
            });

            function tradeStock(action) {
                const symbol = "AAPL";
                const quantity = document.getElementById('quantity').value;

                const buySound = new Audio("{% static 'mp3/buy.mp3' %}");
                const sellSound = new Audio("{% static 'mp3/sell.mp3' %}");
                const buyFailedSound = new Audio("{% static 'mp3/buyFailed.mp3' %}");
                const sellFailedSound = new Audio("{% static 'mp3/sellFailed.mp3' %}");

                {#if (action === 'buy') {#}
                {#    buySound.play();#}
                {# else if (action === 'sell') {#}
                {#    sellSound.play();#}


                fetch("#", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `symbol=${symbol}&quantity=${quantity}&action=${action}`
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const message = action === 'buy' ? 'Buy order placed successfully!' : 'Sell order placed successfully!';
                            showToast(message);
                            if (action === 'buy') {
                                buySound.play();
                            } else {
                                sellSound.play();
                            }
                        } else {
                            const message = action === 'buy' ? 'The buy order was not executed.' : 'The sell order was not executed.';
                            showToast(message);
                            if (action === 'buy') {
                                buyFailedSound.play();
                            } else {
                                sellFailedSound.play();
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        const message = action === 'buy' ? 'The buy order was not executed.' : 'The sell order was not executed.';
                        showToast(message);
                        if (action === 'buy') {
                            buyFailedSound.play();
                        } else {
                            sellFailedSound.play();
                        }
                    });
            }

            function showToast(message) {
                const toastMessage = document.getElementById('toast-message');
                toastMessage.textContent = message;

                const toastElement = document.getElementById('toast');
                const toast = new bootstrap.Toast(toastElement);
                toast.show();
            }

            // Articles 버튼 클릭 이벤트
            document.getElementById('crawl-articles-btn').addEventListener('click', function (event) {
                event.preventDefault();
                showLoading();

                setTimeout(function () {
                    window.location.href = "{% url 'articles' %}";
                }, 100);
            });

            // 로딩창 표시 함수
            function showLoading() {
                document.getElementById('loading').style.display = 'block';
                const progressBar = document.querySelector('.progress');
                const percentDisplay = document.getElementById('progress-percent');
                const loadingMessage = document.querySelector('#loading p');
                progressBar.style.width = '0%';

                let width = 0;
                const interval = setInterval(() => {
                    if (width >= 100) {
                        clearInterval(interval);
                        loadingMessage.textContent = "Still working...";
                    } else {
                        width += 0.5;
                        progressBar.style.width = width + '%';
                        percentDisplay.textContent = Math.floor(width) + '%';
                    }
                }, 50);
                window.onload = function () {
                    clearInterval(interval);
                    progressBar.style.width = '100%';
                    document.getElementById('loading').style.display = 'none';
                };
            }
        });
    </script>
{% endblock %}
